- name: test phpipam modules/lookups
  hosts: all
  gather_facts: no

  vars:
    #free_ip: "{{lookup('phpipam_freeip','10.10.1.0/24','192.168.50.2/api/phpipam/','admin','testpass')}}"

  tasks:
    - name: create ip
      phpipam_address:
        ipam_host: http://192.168.50.2/api/phpipam/
        ip: 10.10.1.1
        subnet: 10.10.1.0/24
        description: wat
        username: admin
        password: testpass
      delegate_to: localhost
      register: create_ip

    - assert:
        that:
          - create_ip.changed

    - name: ensure ip
      phpipam_address:
        ipam_host: http://192.168.50.2/api/phpipam/
        ip: 10.10.1.1
        subnet: 10.10.1.0/24
        description: wat
        username: admin
        password: testpass
      delegate_to: localhost
      register: ensure_ip

    - assert:
        that:
          - not ensure_ip.changed

    - name: delete ip
      phpipam_address:
        ipam_host: http://192.168.50.2/api/phpipam/
        ip: 10.10.1.1
        subnet: 10.10.1.0/24
        description: wat
        state: absent
        username: admin
        password: testpass
      delegate_to: localhost
      register: delete_ip

    - assert:
        that:
          - delete_ip.changed
